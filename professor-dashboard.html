<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Professor Dashboard - Immersive Museum</title>
  <style>
    body { font-family: system-ui, -apple-system, Segoe UI, Roboto, sans-serif; margin: 24px; }
    h1 { margin-bottom: 8px; }
    .actions { display: flex; gap: 8px; }
    table { width: 100%; border-collapse: collapse; margin-top: 16px; }
    th, td { border: 1px solid #ddd; padding: 8px; font-size: 14px; }
    th { background: #f6f6f6; text-align: left; }
    .badge { padding: 2px 8px; border-radius: 12px; font-size: 12px; }
    .hosted { background: #e6ffed; color: #05630b; border: 1px solid #a6f0b5; }
    .not-hosted { background: #fff5e6; color: #8a4b00; border: 1px solid #ffd89c; }
    .upload { margin-top: 16px; border: 1px solid #ddd; padding: 12px; border-radius: 8px; }
    .muted { color: #666; font-size: 13px; }
    input[type="text"] { padding: 6px 8px; font-size: 14px; }
    input[type="file"] { font-size: 14px; }
    button { padding: 6px 10px; font-size: 14px; cursor: pointer; }
    .link { color: #0a58ca; text-decoration: none; }
  </style>
</head>
<body>
  <h1>Professor Dashboard</h1>
  <div class="muted">Manage student submissions: upload, host, unhost, delete.</div>

  <div class="upload">
    <h3>Upload Student Project (ZIP)</h3>
    <form id="uploadForm">
      <div>
        <label>Student Name: <input type="text" name="studentName" required /></label>
      </div>
      <div>
        <label>Project Name: <input type="text" name="projectName" required /></label>
      </div>
      <div>
        <input type="file" name="project" accept=".zip" required />
      </div>
      <button type="submit">Submit Project</button>
      <span id="uploadStatus" class="muted"></span>
    </form>
  </div>

  <table>
    <thead>
      <tr>
        <th>Student</th>
        <th>Project</th>
        <th>Submitted</th>
        <th>Status</th>
        <th>Actions</th>
      </tr>
    </thead>
    <tbody id="rows"></tbody>
  </table>

  <script>
    async function fetchSubmissions() {
      const res = await fetch('/professor/submissions');
      const data = await res.json();
      renderRows(data);
    }

    function renderRows(items) {
      const tbody = document.getElementById('rows');
      tbody.innerHTML = '';
      items.forEach((item) => {
        const tr = document.createElement('tr');
        const hosted = !!item.isHosted;
        const hostedUrl = item.hostedUrl;
        tr.innerHTML = `
          <td>${item.studentName || ''}</td>
          <td>${item.projectName || ''}</td>
          <td>${new Date(item.submittedAt).toLocaleString()}</td>
          <td>
            <span class="badge ${hosted ? 'hosted' : 'not-hosted'}">${hosted ? 'Hosted' : 'Not Hosted'}</span>
            ${hosted && hostedUrl ? ` - <a class="link" href="${hostedUrl}" target="_blank">View</a>` : ''}
          </td>
          <td>
            <div class="actions">
              <input type="text" placeholder="url-path" value="${(item.studentName || 'student').replace(/[^a-zA-Z0-9_-]/g,'_')}" id="url-${item.fileName}">
              <button onclick="host('${item.fileName}')">Host</button>
              <button onclick="unhost('${item.fileName}')">Unhost</button>
              <button onclick="del('${item.fileName}')">Delete</button>
              <a class="link" href="/professor/download/${item.fileName}">Download ZIP</a>
            </div>
          </td>
        `;
        tbody.appendChild(tr);
      });
    }

    async function host(filename) {
      const input = document.getElementById(`url-${filename}`);
      const urlPath = input.value.trim();
      const res = await fetch(`/professor/host/${filename}`, {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ urlPath })
      });
      await fetchSubmissions();
    }

    async function unhost(filename) {
      await fetch(`/professor/unhost/${filename}`, { method: 'POST' });
      await fetchSubmissions();
    }

    async function del(filename) {
      await fetch(`/professor/delete/${filename}`, { method: 'DELETE' });
      await fetchSubmissions();
    }

    const form = document.getElementById('uploadForm');
    form.addEventListener('submit', async (e) => {
      e.preventDefault();
      const fd = new FormData(form);
      const res = await fetch('/submit-project', { method: 'POST', body: fd });
      document.getElementById('uploadStatus').textContent = res.ok ? 'Uploaded!' : 'Upload failed';
      form.reset();
      await fetchSubmissions();
    });

    fetchSubmissions();
  </script>
</body>
</html>
